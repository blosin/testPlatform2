image: docker:stable

variables:
 AWS_ACCOUNT: 382381053403
 ECR_REGION: "us-east-2"
 PROJ_IMG: "smartfran/platform-service"
 ECR_REPOSITORY: "382381053403.dkr.ecr.us-east-2.amazonaws.com"

services:
  - docker:dind

before_script:
  - pip3 install awscli
  - echo $BUILD_TAG

# cache:
#   untracked: true
#   key: '$CI_BUILD_REF_NAME'
#   paths:
#     - api/node_modules/
#     - api/src/platforms/sdk/pedidosYa/node_modules/

stages:
  - clean
  - unit-test
  - static-test
  - build
  - restore-db
  - push-image
  - deploy-testing

# clean:
#   stage: clean
#   script:
#     - echo "Removing all containers"
#     #- test $(docker ps -aq) && docker rm -f $(docker ps -aq)
#     - echo "Prune all docker stuff without use"
#     - docker system prune --force --all --volumes
#     - echo "Clean npm garbage"
#     - rm -rf node_modules package-lock.json yarn-lock.json
#   only:
#     - test_devops
#   tags:adad
#     - runner-smartfran

unit-test:
  stage: unit-test
  before_script:
    - cd api/src/platforms/sdk/pedidosYa ; npm i ; cd ../../../.. ; npm i
  script:
    - npm run test
  tags:
    - smartfran-runner
  only:
    - test_devops

build-test:
  stage: build
  before_script:
    - cd api
  script:
   - pwd
   - echo "Building image..."
   - echo $IMAGE_TAG
   - docker build -t $PROJ_IMG .
   - echo "Tagging image..."
   - docker tag $PROJ_IMG $ECR_REPOSITORY/$PROJ_IMG:latest
   - echo "Pushing image..."
  tags:
    - smartfran-runner
  only:
    - test_devops

push:
  stage: push-image
  script:
   - echo "Login to ECR"
   - aws ecr get-login-password --region $ECR_REGION | docker login --username AWS --password-stdin $ECR_REPOSITORY
   - echo "Pushing image..."
   - echo $ECR_REPOSITORY/$PROJ_IMG:latest
   - docker push $ECR_REPOSITORY/$PROJ_IMG:latest
  after_script:
   - docker system prune --force --all --volumes
  tags:
   - smartfran-runner
      

deploy.testing:
  stage: deploy-testing
  variables:
   BRANCH_NAME: "testing"
   SERVICE_NAME: "platform-service"
   ECS_REGION: "us-east-2"
   CLUSTER: "smartfran-pedidos-common"
   SERVICE: "${SERVICE_NAME}-${BRANCH_NAME}-service"
   TASK: "${SERVICE_NAME}-${BRANCH_NAME}-task"
   PROJ_IMG: "smartfran/${SERVICE_NAME}"
   ECR_REPOSITORY: "382381053403.dkr.ecr.us-east-2.amazonaws.com"
   PROFILE: "smartfran"
   ENV: "testing"

script:
  - cd api
  - echo "Deploying version $PROJ_IMG"
  - echo $PROJ_IMG
  - echo $ECS_TEMPLATE
  - envsubst < container-definitions-mock.json > ecs-container-definitions.json
  - aws ecs register-task-definition --cli-input-json file://ecs-container-definitions.json --region $ECS_REGION
# deploy-production:
#   extends: .deploy
#   before_script:
#     - export BUILD_TAG="$CI_COMMIT_TAG"
#   variables:
#     ENV: prod
#     CLUSTER: inviertis-$ENV
#     SERVICE: inviertis-api-$ENV-service
#     TASK: inviertis-api-$ENV-task
#     ECS_REGION: us-east-1
#     ECS_TEMPLATE: ./infra-templates/ecs-fargate-container-definitions.json
#   when: manual
#   only:
#     - tags
#   environment: $CI_COMMIT_REF_SLUG

